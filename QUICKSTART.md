# Quick Start Guide

## Prerequisites

- Bun installed: `curl -fsSL https://bun.sh/install | bash`
- Docker (optional, for local infrastructure)

## Setup Steps

### 1. Install Dependencies

```bash
bun install
```

### 2. Start Infrastructure (Optional)

If you don't have PostgreSQL and Redis running, use Docker:

```bash
# Start PostgreSQL
cd backend/infra/postgres
docker-compose up -d

# Start Redis
cd backend/infra/redis
docker-compose up -d
```

### 3. Configure Environment

Create a `.env` file in the root:

```bash
DATABASE_URL=postgresql://lokaly:lokaly@localhost:5432/lokaly
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-public-api-secret
ADMIN_JWT_SECRET=your-admin-api-secret
```

### 4. Start Services

```bash
# Start all services
bun run dev:all

# Or start individually:
bun run dev:public-api  # Port 3000
bun run dev:admin-api   # Port 3001
bun run dev:worker      # Background jobs
```

## Testing the APIs

### Public API

#### 1. Health Check
```bash
curl http://localhost:3000/health
```

#### 2. Create Order (requires JWT)

First, generate a JWT token (in production, this comes from your auth service):

```bash
# Example: Create order
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "items": [
      {
        "productId": "prod-123",
        "quantity": 2,
        "price": 29.99
      }
    ],
    "deliveryAddress": "123 Main St, City, State 12345"
  }'
```

#### 3. Get Order
```bash
curl http://localhost:3000/api/orders/ORDER_ID \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 4. WebSocket Connection (Real-time Tracking)

```javascript
const ws = new WebSocket('ws://localhost:3000/ws/orders/ORDER_ID', {
  headers: {
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  }
});

ws.onmessage = (event) => {
  console.log('Order update:', JSON.parse(event.data));
};
```

### Admin API

#### 1. Health Check
```bash
curl http://localhost:3001/health
```

#### 2. List All Orders (requires admin JWT)
```bash
curl http://localhost:3001/api/admin/orders \
  -H "Authorization: Bearer ADMIN_JWT_TOKEN"
```

#### 3. Get Order Details
```bash
curl http://localhost:3001/api/admin/orders/ORDER_ID \
  -H "Authorization: Bearer ADMIN_JWT_TOKEN"
```

#### 4. Update Order Status (super_admin only)
```bash
curl -X PATCH http://localhost:3001/api/admin/orders/ORDER_ID/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SUPER_ADMIN_JWT_TOKEN" \
  -d '{
    "status": "confirmed"
  }'
```

## Generating JWT Tokens

In production, JWT tokens are generated by your authentication service. For development/testing, you can create a simple script:

```typescript
// scripts/generate-token.ts
import { JwtService } from "@lokaly/auth";

const jwtService = new JwtService(process.env.JWT_SECRET || "secret");

const token = await jwtService.sign({
  userId: "user-123",
  role: "customer", // or "courier", "admin", "super_admin"
  email: "user@example.com"
});

console.log("Token:", token);
```

Run with: `bun scripts/generate-token.ts`

## Event Flow Example

When you create an order:

1. **Public API** receives POST `/api/orders`
2. **OrderService** creates order in database
3. **OrderService** emits `order.created` event to Redis
4. **Worker** consumes `order.created` event
5. **Worker** reserves inventory (emits `inventory.reserved`)
6. **Worker** updates order status to "confirmed"
7. **Public API** broadcasts status update to WebSocket clients

## Monitoring

### Check Worker Logs

The worker logs all processed events:
```
[Worker] Processing event: order.created (abc-123)
[Worker] Successfully processed event: order.created
```

### Check Redis Events

Events are published to Redis streams. You can monitor them:
```bash
redis-cli XREAD STREAMS domain-events 0
```

## Troubleshooting

### Module Resolution Errors

If you see "Cannot find module '@lokaly/...'" errors:
1. Make sure you ran `bun install`
2. Check that workspace packages are in `package.json` workspaces
3. Restart your IDE/TypeScript server

### Database Connection Errors

1. Verify PostgreSQL is running: `docker ps`
2. Check connection string in `.env`
3. Ensure database exists: `createdb lokaly`

### Redis Connection Errors

1. Verify Redis is running: `redis-cli ping`
2. Check Redis URL in `.env`
3. Ensure Redis is accessible from your network

### Port Already in Use

If ports 3000 or 3001 are in use:
1. Change ports in `.env`:
   ```
   PUBLIC_API_PORT=3002
   ADMIN_API_PORT=3003
   ```
2. Or kill the process using the port:
   ```bash
   lsof -ti:3000 | xargs kill
   ```

## Next Steps

- Read [ARCHITECTURE.md](./ARCHITECTURE.md) for detailed architecture
- Read [README.md](./README.md) for full documentation
- Add your business logic to domain packages
- Implement your authentication service
- Add monitoring and logging

